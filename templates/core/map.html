{% extends 'base.html' %} {% block title %}Map View - RoadHealth AI{% endblock %}
 {% block content %}
<div class="fade-in">
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">
      <i class="fas fa-map-marked-alt mr-2"></i> Road Condition Map
    </h1>
    <p class="text-gray-600">View all geotagged road images on the map</p>
  </div>

  <!-- Map Container -->
  <div class="bg-white rounded-lg shadow-md p-4">
    <div id="map" style="height: 600px; width: 100%" class="rounded-lg"></div>
  </div>

  <!-- Legend -->
  <div class="bg-white rounded-lg shadow-md p-6 mt-6">
    <h3 class="text-lg font-bold text-gray-800 mb-4">Map Legend</h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="flex items-center">
        <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
        <span class="text-sm text-gray-700">Good Condition</span>
      </div>
      <div class="flex items-center">
        <div class="w-4 h-4 bg-yellow-500 rounded-full mr-2"></div>
        <span class="text-sm text-gray-700">Moderate</span>
      </div>
      <div class="flex items-center">
        <div class="w-4 h-4 bg-orange-500 rounded-full mr-2"></div>
        <span class="text-sm text-gray-700">Poor</span>
      </div>
      <div class="flex items-center">
        <div class="w-4 h-4 bg-red-500 rounded-full mr-2"></div>
        <span class="text-sm text-gray-700">Critical</span>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
  // Map data from Django
  const mapData = {{ map_data|safe }};

  // Initialize map
  function initMap() {
      // Default center (you can change this)
      const defaultCenter = mapData.length > 0
          ? { lat: mapData[0].lat, lng: mapData[0].lng }
          : { lat: 40.7128, lng: -74.0060 }; // New York as default

      const map = new google.maps.Map(document.getElementById('map'), {
          zoom: 12,
          center: defaultCenter,
          mapTypeId: 'roadmap'
      });

      // Color mapping for severity
      const severityColors = {
          'good': '#10B981',
          'moderate': '#F59E0B',
          'poor': '#F97316',
          'critical': '#EF4444',
          'default': '#6B7280'
      };

      // Add markers
      mapData.forEach(function(data) {
          const color = severityColors[data.severity] || severityColors.default;

          const marker = new google.maps.Marker({
              position: { lat: data.lat, lng: data.lng },
              map: map,
              title: data.title,
              icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: 10,
                  fillColor: color,
                  fillOpacity: 0.8,
                  strokeColor: '#FFFFFF',
                  strokeWeight: 2
              }
          });

          // Info window
          const infoContent = `
              <div style="padding: 10px;">
                  <h3 style="font-weight: bold; margin-bottom: 5px;">${data.title}</h3>
                  <p style="margin: 5px 0;"><strong>Location:</strong> ${data.location || 'N/A'}</p>
                  ${data.defect_type ? `<p style="margin: 5px 0;"><strong>Defect:</strong> ${data.defect_type}</p>` : ''}
                  ${data.severity ? `<p style="margin: 5px 0;"><strong>Condition:</strong> <span style="color: ${color}; font-weight: bold;">${data.severity.toUpperCase()}</span></p>` : ''}
                  <a href="/core/images/${data.id}/" style="color: #2563EB; text-decoration: underline;">View Details</a>
              </div>
          `;

          const infoWindow = new google.maps.InfoWindow({
              content: infoContent
          });

          marker.addListener('click', function() {
              infoWindow.open(map, marker);
          });
      });

      // Fit bounds to show all markers
      if (mapData.length > 0) {
          const bounds = new google.maps.LatLngBounds();
          mapData.forEach(data => {
              bounds.extend({ lat: data.lat, lng: data.lng });
          });
          map.fitBounds(bounds);
      }
  }
</script>

<!-- Google Maps API -->
<script
  async
  defer
  src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap"
></script>

<!-- Fallback if no API key -->
{% if not google_maps_api_key %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("map").innerHTML = `
            <div class="flex items-center justify-center h-full bg-gray-100 rounded-lg">
                <div class="text-center p-8">
                    <i class="fas fa-map-marked-alt text-gray-400 text-6xl mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-700 mb-2">Google Maps API Key Required</h3>
                    <p class="text-gray-600">Please add your Google Maps API key to .env file</p>
                    <p class="text-sm text-gray-500 mt-2">GOOGLE_MAPS_API_KEY=your-api-key</p>
                </div>
            </div>
        `;
  });
</script>
{% endif %} {% endblock %} {% endblock %}
